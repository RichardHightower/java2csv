sequenceDiagram
    participant log as log
    participant offerEntities as Map<LocalDate, Set<OfferEntity>>
    participant monthResponses as List<MonthResponse>
    participant dayResponsesMap as Map<String, List<DayResponse>>
    participant deliveryWindowResponses as List<DeliveryWindowResponse>
    participant date as LocalDate
    participant entities as Set<OfferEntity>
    participant Utils as Utils
    participant dayResponse as DayResponse
    participant deliveryDate as LocalDate
    participant deliveryDateYearMonth as String
    participant previousDayResponses as List<DayResponse>
    participant responseGroupedByMonth as Map<List<Integer>, List<DayResponse>>
    participant gc as List<Integer>
    participant dr as List<DayResponse>
    participant monthResponse as MonthResponse

    log->>log: trace("Start fromOfferEntitiesFilterAndGroupByDate")
    log-->>log: debug("fromDate: {}; toDate: {}", fromDate, toDate)
    offerEntities-->>entities: forEach(date, entities)
    entities->>Utils: convertDeliveryWindow(offerEntity)
    Utils-->>entities: deliveryWindowResponses
    deliveryWindowResponses-->>deliveryWindowResponses: filter(Objects::nonNull)
    deliveryWindowResponses-->>deliveryWindowResponses: flatMap(List::stream)
    deliveryWindowResponses->>deliveryWindowResponses: sort(Comparator.comparing(DeliveryWindowResponse::getCutoff))
    deliveryWindowResponses-->>dayResponse: create dayResponse
    date->>Utils: buildYearMonthKey(date.getYear(), date.getMonthValue())
    dayResponsesMap-->>dayResponsesMap: getOrDefault(deliveryDateYearMonth, new ArrayList<>())
    previousDayResponses-->>previousDayResponses: add(dayResponse)
    dayResponsesMap-->>dayResponsesMap: put(deliveryDateYearMonth, previousDayResponses)
    dayResponsesMap-->>responseGroupedByMonth: values().stream()
    responseGroupedByMonth-->>responseGroupedByMonth: flatMap(List::stream)
    responseGroupedByMonth->>responseGroupedByMonth: groupingBy(dayResponse -> Arrays.asList(dayResponse.getDeliveryDate().getYear(), dayResponse.getDeliveryDate().getMonthValue()))
    responseGroupedByMonth-->>monthResponses: forEach((gc, dr))
    deliveryDate->>Utils: buildYearMonthKey(gc.get(0), gc.get(1))
    monthResponses-->>monthResponses: add(monthResponse)
    return-->monthResponses