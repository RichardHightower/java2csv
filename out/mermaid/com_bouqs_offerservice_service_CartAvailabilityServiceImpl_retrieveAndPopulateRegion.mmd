---
title: retrieveAndPopulateRegion
---

sequenceDiagram
    participant CartAvailabilityServiceImpl
    participant List<CartItemRequest>
    participant log
    participant Stream
    participant Collectors
    participant String
    participant postalCode
    participant List<RegionResponse>
    participant webClientService
    participant Utils
    participant item

    CartAvailabilityServiceImpl->>log: Start retrieveAndPopulateRegion
    CartAvailabilityServiceImpl->>List<CartItemRequest>: cartItemRequests
    List<CartItemRequest]->>Stream: stream()
    Stream->>map: map(cartItemRequest -> cartItemRequest.getDestination().getPostalCode())
    map->>distinct: distinct()
    distinct->>Collectors: collect(Collectors.toMap(String::toString, postalCode -> {...}))
    Collectors->>String: String::toString
    Collectors->>postalCode: postalCode -> {...}
    postalCode->>webClientService: getRegionsByDesZipCode(postalCode)
    webClientService->>List<RegionResponse>: regionResponses
    List<RegionResponse]->>Stream: stream()
    Stream->>map: map(item -> Utils.buildRegionId(item.getShipMethodId(), item.getRegion(), item.getDays()))
    map->>Collectors: collect(Collectors.toList())
    Collectors->>List<String>: Collectors.toList()
    List<String]-->>Collectors: Return regionIds
    Collectors-->>map: Return regionIds
    map-->>Stream: Return regionIds
    Stream-->>Collectors: Return regionIds
    Collectors-->>distinct: Return regionIds
    distinct-->>map: Return regionIds
    map-->>Stream: Return regionIds
    Stream-->>List<CartItemRequest>: Return regionIds
    List<CartItemRequest]-->>CartAvailabilityServiceImpl: Return regionIds
